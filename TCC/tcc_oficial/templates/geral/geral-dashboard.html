{% load static %}

<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SENAI - Ordens de Serviço</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link href="{% static 'css/output.css' %}" rel="stylesheet">
    <link href="{% static 'css/geraldashboard.css' %}" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
      /* Estilos do modal */
.modal {
  display: none;
  position: fixed;
  z-index: 1;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0, 0, 0, 0.4);
}

.modal-content {
  background-color: #fefefe;
  margin: 15% auto;
  padding: 20px;
  border: 1px solid #888;
  width: 80%;
  max-width: 600px;
}

.close-btn {
  color: #aaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
}

.close-btn:hover,
.close-btn:focus {
  color: black;
  text-decoration: none;
  cursor: pointer;
}

form input, form select, form button {
  width: 100%;
  margin: 10px 0;
  padding: 10px;
  box-sizing: border-box;
}

    </style>
  </head>
  <body>

    {% include 'components/geral-header.html' %}

    <div class="search-bar" style="width: 100%; display: flex; justify-content: center; align-items: center; height: 80px;">
      <a class="new-service-button" href="{% url 'novo_servico_geral' %}" style="padding: 15px 15px 15px 15px; color: white; border-radius: 15px;">Novo Serviço</a>
    </div>

    <!-- Tabela principal -->
    <h2 style="display: flex; justify-content: center; margin-bottom: 15px">
      Suas ordens de serviços solicitadas
    </h2>
    <table id="osTable" class="styled-table">
      <thead>
        <tr>
          <th>Nome</th>
          <th>Descrição</th>
          <th>Atribuído a</th>
          <th>Status</th>
          <th>Ambiente</th>
          <th>Data do Pedido</th>
          <th>Data Limite</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- Tabela para ordens de serviço finalizadas -->
    <h2
      style="
        display: flex;
        justify-content: center;
        margin-top: 50px;
        margin-bottom: 20px;
      "
    >
      Serviços Finalizados
    </h2>
    <table id="osFinalizadasTable" class="styled-table">
      <thead>
        <tr>
          <th>Nome</th>
          <th>Descrição</th>
          <th>Atribuído a</th>
          <th>Status</th>
          <th>Ambiente</th>
          <th>Data do Pedido</th>
          <th>Data Limite</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p id="noFinalizados" style="text-align: center; display: none">
      Nenhum serviço finalizado encontrado.
    </p>


<!-- Modal para edição -->
<div id="editModal" class="modal">
  <div class="modal-content"  style="border-radius: 15px;">
    <span class="close-btn">&times;</span>
    <h2>Editar Ordem de Serviço</h2>
    <br>
    <form id="editForm">
      <label for="nome">Nome</label>
      <input type="text" id="nome" name="nome" required />

      <label for="descricao">Descrição</label>
      <input type="text" id="descricao" name="descricao" required />

      <label for="atribuido">Atribuído a</label>
      <input type="text" id="atribuido" name="atribuido" required />

      <label for="status">Status</label>
      <input type="text" id="statusDisplay" name="status" readonly /> <!-- Usar readonly para não ser editado -->

      <label for="ambiente">Ambiente</label>
      <input type="text" id="ambiente" name="ambiente" required />

      <label for="dataLimite">Data Limite</label>
      <input type="date" id="dataLimite" name="dataLimite" required />

      <button type="submit" style="padding: 20px; background-color: #900000; color: white; border-radius: 15px;">Salvar alterações</button>
    </form>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import {
    getFirestore,
    collection,
    query,
    where,
    getDocs,
    deleteDoc,
    doc,
    getDoc,
    updateDoc
  } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBjHux5Th122xDRmD35KsdjfTzrezHU8bY", // Substitua por sua chave de API real
    authDomain: "fir-crud-56c52.firebaseapp.com",
    projectId: "fir-crud-56c52",
    storageBucket: "fir-crud-56c52.appspot.com",
    messagingSenderId: "906266562649",
    appId: "1:906266562649:web:55742c6c6b67449857e148",
    measurementId: "G-VN53GXMXM6",
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const nomeUsuario = sessionStorage.getItem("nome");

  if (!nomeUsuario) {
    document.querySelector("#userGreeting").textContent =
      "Bem-vindo de volta, Anônimo!";
  } else {
    document.querySelector(
      "#userGreeting"
    ).textContent = `Bem-vindo de volta, ${nomeUsuario}!`;
    loadOrdensServico(nomeUsuario);
    loadOrdensFinalizadas(nomeUsuario); // Carrega os serviços finalizados
  }

  async function loadOrdensServico(nomeUsuario) {
    const q = query(
      collection(db, "ordemServicos"),
    where("criador", "==", nomeUsuario),
        // where("status", "in", ["Finalizado", "Cancelado"]) // Aqui ajustamos para incluir os status Finalizado ou Cancelado

    );

    try {
      const querySnapshot = await getDocs(q);
      const osTable = document.querySelector("#osTable tbody");
      osTable.innerHTML = "";

      querySnapshot.forEach((doc) => {
        const osData = doc.data();
        const row = document.createElement("tr");
        const atribuido = osData.atribuido
          ? osData.atribuido
          : "Não atribuído";
        const status = osData.status && osData.status !== "Cancelado" ? osData.status : "Em análise";

        row.innerHTML = `
          <td>${osData.nome}</td>
          <td>${osData.descricao}</td>
          <td>${atribuido}</td>
          <td>${status}</td>
          <td>${osData.ambiente}</td>
          <td>${osData.dataPedido}</td>
          <td>${osData.dataLimite}</td>
          <td>
            <button class="editOSButton" data-id="${doc.id}">
              <i class="fas fa-pen"></i>
            </button>
            <button class="deleteOSButton" data-id="${doc.id}">
              <i class="fas fa-times"></i>
            </button>
          </td>
        `;
        osTable.appendChild(row);
      });

      // Adicionar eventos de clique aos botões de editar e excluir
      const editButtons = document.querySelectorAll('.editOSButton');
      editButtons.forEach(button => {
        button.addEventListener('click', function() {
          editOS(button.getAttribute('data-id'));
        });
      });

      const deleteButtons = document.querySelectorAll('.deleteOSButton');
      deleteButtons.forEach(button => {
        button.addEventListener('click', function() {
          deleteOS(button.getAttribute('data-id'));
        });
      });

    } catch (error) {
      console.error("Erro ao buscar ordens de serviço:", error);
    }
  }

  function editOS(id) {
  const modal = document.getElementById("editModal");
  const closeBtn = document.querySelector(".close-btn");

  // Buscar a ordem de serviço no Firestore
  const osRef = doc(db, "ordemServicos", id);
  getDoc(osRef).then((docSnapshot) => {
    if (docSnapshot.exists()) {
      const osData = docSnapshot.data();

      // Preencher o modal com as informações da ordem de serviço
      document.getElementById("nome").value = osData.nome;
      document.getElementById("descricao").value = osData.descricao;
      document.getElementById("atribuido").value = osData.atribuido || "Não atribuído";
      
      // Preencher o campo de status, mas tornar o campo readonly
      const statusDisplay = document.getElementById("statusDisplay");
      statusDisplay.value = osData.status; // Exibir o status, mas sem permitir edição

      document.getElementById("ambiente").value = osData.ambiente;
      document.getElementById("dataLimite").value = osData.dataLimite;

      // Exibir o modal
      modal.style.display = "block";

      // Quando o usuário fechar o modal
      closeBtn.onclick = function () {
        modal.style.display = "none";
      };

      // Quando o usuário clicar fora do modal, ele será fechado
      window.onclick = function (event) {
        if (event.target === modal) {
          modal.style.display = "none";
        }
      };

      // Atualizar os dados ao submeter o formulário
      const form = document.getElementById("editForm");
      form.onsubmit = function (e) {
        e.preventDefault();

        const updatedOS = {
          nome: document.getElementById("nome").value,
          descricao: document.getElementById("descricao").value,
          atribuido: document.getElementById("atribuido").value,
          status: osData.status, // Mantém o status atual (não editável)
          ambiente: document.getElementById("ambiente").value,
          dataLimite: document.getElementById("dataLimite").value,
        };

        // Atualizar a ordem de serviço no Firestore
        updateDoc(osRef, updatedOS)
          .then(() => {
            alert("Ordem de serviço atualizada com sucesso!");
            modal.style.display = "none";
            location.reload();
          })
          .catch((error) => {
            console.error("Erro ao atualizar a ordem de serviço:", error);
          });
      };
    } else {
      console.log("Ordem de serviço não encontrada");
    }
  }).catch((error) => {
    console.error("Erro ao buscar a ordem de serviço:", error);
  });
}
  function deleteOS(id) {
    if (confirm("Tem certeza que deseja excluir esta ordem de serviço?")) {
      deleteDoc(doc(db, "ordemServicos", id))
        .then(() => {
          alert("Ordem de serviço excluída com sucesso!");
          location.reload();
        })
        .catch((error) => {
          console.error("Erro ao excluir a ordem de serviço:", error);
        });
    }
  }

async function loadOrdensFinalizadas(nomeUsuario) {
  const q = query(
    collection(db, "ordemServicos"),
    where("criador", "==", nomeUsuario),
    where("status", "in", ["Finalizado", "Cancelado"]) // Carregar apenas as ordens com status Finalizado ou Cancelado
  );

  try {
    const querySnapshot = await getDocs(q);
    const osFinalizadasTable = document.querySelector("#osFinalizadasTable tbody");
    osFinalizadasTable.innerHTML = ""; // Limpar a tabela antes de adicionar as novas ordens

    if (querySnapshot.empty) {
      document.getElementById("noFinalizados").style.display = "block"; // Mostrar mensagem de nenhum serviço encontrado
    } else {
      document.getElementById("noFinalizados").style.display = "none"; // Esconder a mensagem se houver serviços

      querySnapshot.forEach((doc) => {
        const osData = doc.data();
        const row = document.createElement("tr");

        const atribuido = osData.atribuido
          ? osData.atribuido
          : "Não atribuído";

        row.innerHTML = `
        <td>${osData.nome}</td>
          <td>${osData.descricao}</td>
          <td>${atribuido}</td>
          <td>${osData.status}</td>
          <td>${osData.ambiente}</td>
          <td>${osData.dataPedido}</td>
          <td>${osData.dataLimite}</td>
        `;
        osFinalizadasTable.appendChild(row);
      });
    }

  } catch (error) {
    console.error("Erro ao buscar ordens de serviço finalizadas:", error);
  }
}

</script>

  </body>
</html>
