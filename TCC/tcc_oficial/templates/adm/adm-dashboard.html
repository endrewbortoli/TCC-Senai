{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adm Dashboard</title>
    <link rel="stylesheet" href="{% static 'css/admdashboard.css'%}">
    <link rel="stylesheet" href="{% static 'css/modal.css'%}">
    <link href="{% static 'css/output.css' %}" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="side-right">
        <!-- Sidebar Menu -->
        {% include 'components/adm-sidebar.html' %} 
  
        <!-- Main content -->
        <div class="main">
            <!-- Header -->
            {% include 'components/adm-header.html' %}
  
            <!-- Status Section -->
            <div class="nicolas">
                <div class="status-container">
                    <div class="status-box">
                        <h2>NÃO ATRIBUÍDOS</h2>
                        <span id="naoAtribuidosCount">0</span>
                    </div>
                    <div class="status-box">
                        <h2>EM ANDAMENTO</h2>
                        <span id="emAndamentoCount">0</span>
                    </div>
                    <div class="status-box">
                        <h2>ESPERANDO CONFIRMAÇÃO</h2>
                        <span id="emAnaliseCount">0</span>
                    </div>
                </div>
  
                <!-- Content Section (Table) -->
                <div class="content">
                    <h2>Detalhes</h2>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>NOME</th>
                                <th>CRIADOR</th>
                                <th>DATA LIMITE</th>
                                <th>PRIORIDADE</th>
                                <th>STATUS</th>
                                <th>DETALHES</th>
                            </tr>
                        </thead>
                        <tbody id="ordemServicosTableBody">
                            <!-- Dados serão preenchidos dinamicamente aqui -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para exibir detalhes gerais -->
<!-- Modal para exibir detalhes gerais -->
<div id="detalhesModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Detalhes da Ordem de Serviço</h2>
        <p><strong>Ambiente:</strong> <span id="modalAmbiente"></span></p>
        <p><strong>Criador:</strong> <span id="modalCriador"></span></p>
        <p><strong>Data Limite:</strong> <span id="modalDataLimite"></span></p>
        <p><strong>Data do Pedido:</strong> <span id="modalDataPedido"></span></p>
        <p><strong>Descrição:</strong> <span id="modalDescricao"></span></p>
        <p><strong>Prioridade:</strong> <span id="modalPrioridade"></span></p>
        <!-- <p><strong>Status:</strong>
            <select id="modalStatusSelect">
                <option value="Em andamento">Em andamento</option>
                <option value="Esperando Confirmação">Esperando Confirmação</option>
                <option value="Esperando Confirmação">Esperando Confirmação</option>
            </select>
        </p> -->
        <p><strong>Tipo de Solicitação:</strong> <span id="modalTipoSolicitacao"></span></p>

        <!-- Adicionado campo para editar "Atribuído a" -->
        <p><strong>Atribuído a:</strong> 
            <select id="modalAtribuido">
                <!-- Opções serão preenchidas dinamicamente -->
            </select>
        </p>

        <!-- <button id="saveStatusButton" style="background-color: #900000; padding: 20px; color: white; border-radius: 10px;">Salvar Status</button> -->
        <button id="saveAtribuidoButton" style="background-color: #900000; padding: 20px; color: white; border-radius: 10px;">Salvar Atribuíção</button>
    </div>
</div>

    <!-- Modal para Análise -->
    <div id="analiseModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Detalhes da Ordem de Serviço - Análise</h2>
            <p><strong>Ambiente:</strong> <span id="modalAmbienteAnalise"></span></p>
            <p><strong>Criador:</strong> <span id="modalCriadorAnalise"></span></p>
            <p><strong>Data Limite:</strong> <span id="modalDataLimiteAnalise"></span></p>
            <p><strong>Data do Pedido:</strong> <span id="modalDataPedidoAnalise"></span></p>
            <p><strong>Descrição:</strong> <span id="modalDescricaoAnalise"></span></p>
            <p><strong>Prioridade:</strong> <span id="modalPrioridadeAnalise"></span></p>
            <p><strong>Status:</strong> <span id="modalStatusAnalise"></span></p>
            <p><strong>Tipo de Solicitação:</strong> <span id="modalTipoSolicitacaoAnalise"></span></p>
            <button id="aprovarButton" style="padding: 25px; background-color: #900000; margin-right: 15px; border-radius: 15px; color: white;">Aprovar</button>
            <button id="recusarButton" style="padding: 25px; background-color: #900000; border-radius: 15px; color: white;">Recusar</button>
        </div>
    </div>

<script type="module" src="{% static 'js/verificacao.js' %}"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getFirestore, getDocs, collection, query, where, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBjHux5Th122xDRmD35KsdjfTzrezHU8bY",
        authDomain: "fir-crud-56c52.firebaseapp.com",
        projectId: "fir-crud-56c52",
        storageBucket: "fir-crud-56c52.appspot.com",
        messagingSenderId: "906266562649",
        appId: "1:906266562649:web:55742c6c6b67449857e148",
        measurementId: "G-VN53GXMXM6",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Função para preencher a tabela com dados de Firestore filtrados por status
    async function loadOrdensServicos() {
        const q = query(collection(db, "ordemServicos"), where("status", "in", ["Não atribuído", "Em andamento", "Em análise", "Atribuído", "Concluído"]));
        const querySnapshot = await getDocs(q);
        const tableBody = document.getElementById("ordemServicosTableBody");

        tableBody.innerHTML = ""; // Limpa o conteúdo da tabela

        querySnapshot.forEach((doc) => {
            const ordemServico = doc.data();
            const row = document.createElement("tr");

            // Verifica o status para decidir o texto do botão
            const buttonLabel = ordemServico.status === "Em análise" ? "ANALISAR" : "VER MAIS";

            row.innerHTML = `
                <td>${ordemServico.nome || "Sem nome"}</td>
                <td>${ordemServico.criador || "Desconhecido"}</td>
                <td>${ordemServico.dataLimite || "Sem data"}</td>
                <td>${ordemServico.prioridade || "Normal"}</td>
                <td>${ordemServico.status || "Indefinido"}</td>
                <td><button class="verMaisBtn" data-id="${doc.id}">${buttonLabel}</button></td>
            `;

            tableBody.appendChild(row);
        });

        // Adiciona evento de clique aos botões "VER MAIS" ou "ANALISAR"
        document.querySelectorAll(".verMaisBtn").forEach((button) => {
            button.addEventListener("click", (event) => {
                const ordemId = event.target.getAttribute("data-id");
                if (event.target.textContent === "ANALISAR") {
                    showAnaliseModal(ordemId); // Abre o modal de análise
                } else {
                    showOrdemServicoDetails(ordemId); // Abre o modal de detalhes
                }
            });
        });
    }

// Função para exibir os detalhes da ordem de serviço no modal
// Função para buscar e preencher os usuários de "Trabalhador"
const preencherUsuariosManutencao = async () => {
    const atribuidoSelect = document.getElementById("modalAtribuido");

    try {
        // Consultar os usuários com tipoUsuario "Trabalhador"
        const q = query(collection(db, "users"), where("tipoUsuario", "==", "Trabalhador"));
        const querySnapshot = await getDocs(q);

        // Limpa as opções do select antes de preencher
        atribuidoSelect.innerHTML = "";

        // Adicionar uma opção padrão para o select
        const defaultOption = document.createElement("option");
        defaultOption.value = "";
        defaultOption.textContent = "Selecione um trabalhador";
        atribuidoSelect.appendChild(defaultOption);

        // Adicionar cada usuário ao campo de seleção
        querySnapshot.forEach((doc) => {
            const userData = doc.data();
            const option = document.createElement("option");
            option.value = userData.nome;
            option.textContent = userData.nome;
            atribuidoSelect.appendChild(option);
        });
    } catch (error) {
        console.error("Erro ao buscar usuários de Trabalhador: ", error);
    }
};

// Função para exibir os detalhes da ordem de serviço no modal
async function showOrdemServicoDetails(ordemId) {
    const docRef = collection(db, "ordemServicos");
    const docSnapshot = await getDocs(query(docRef, where("__name__", "==", ordemId)));

    docSnapshot.forEach((doc) => {
        const ordemServico = doc.data();

        // Preenche o modal com os detalhes da ordem de serviço
        document.getElementById("modalAmbiente").textContent = ordemServico.ambiente || "Sem ambiente";
        document.getElementById("modalCriador").textContent = ordemServico.criador || "Desconhecido";
        document.getElementById("modalDataLimite").textContent = ordemServico.dataLimite || "Sem data";
        document.getElementById("modalDataPedido").textContent = ordemServico.dataPedido || "Sem data";
        document.getElementById("modalDescricao").textContent = ordemServico.descricao || "Sem descrição";
        document.getElementById("modalPrioridade").textContent = ordemServico.prioridade || "Normal";
        document.getElementById("modalTipoSolicitacao").textContent = ordemServico.tipoSolicitacao || "Sem tipo";

        // Preenche o campo "Atribuído a" com o valor atual
        document.getElementById("modalAtribuido").value = ordemServico.atribuido || "";

        // Exibe o modal
        document.getElementById("detalhesModal").style.display = "block";
    });

    // Preenche o select com os trabalhadores
    preencherUsuariosManutencao();

    // Evento para salvar "Atribuído a"
    document.getElementById("saveAtribuidoButton").onclick = async function() {
        const newAtribuido = document.getElementById("modalAtribuido").value;
        if (newAtribuido) {  // Apenas salva se o "Atribuído a" não estiver vazio
            await updateOrdensServicosAtribuido(ordemId, newAtribuido);
        } else {
            alert("Por favor, selecione um trabalhador.");
        }
    };
}

// Função para atualizar o campo "Atribuído a" no Firestore e alterar o status para "Atribuído"
async function updateOrdensServicosAtribuido(ordemId, newAtribuido) {
    const docRef = doc(db, "ordemServicos", ordemId);
    
    // Atualiza o campo "Atribuído a" e altera o status para "Atribuído"
    await updateDoc(docRef, {
        atribuido: newAtribuido,
        status: "Atribuído"  // Altera o status para "Atribuído"
    });

    // Fechar o modal após a atualização
    document.getElementById("detalhesModal").style.display = "none";
    loadOrdensServicos();  // Atualiza a lista de ordens de serviço
    countOrdensServicos();  // Atualiza os contadores de status
}
    // Função para exibir o modal de análise
    async function showAnaliseModal(ordemId) {
        const docRef = collection(db, "ordemServicos");
        const docSnapshot = await getDocs(query(docRef, where("__name__", "==", ordemId)));

        docSnapshot.forEach((doc) => {
            const ordemServico = doc.data();

            // Preenche o modal com os detalhes da ordem de serviço
            document.getElementById("modalAmbienteAnalise").textContent = ordemServico.ambiente || "Sem ambiente";
            document.getElementById("modalCriadorAnalise").textContent = ordemServico.criador || "Desconhecido";
            document.getElementById("modalDataLimiteAnalise").textContent = ordemServico.dataLimite || "Sem data";
            document.getElementById("modalDataPedidoAnalise").textContent = ordemServico.dataPedido || "Sem data";
            document.getElementById("modalDescricaoAnalise").textContent = ordemServico.descricao || "Sem descrição";
            document.getElementById("modalPrioridadeAnalise").textContent = ordemServico.prioridade || "Normal";
            document.getElementById("modalStatusAnalise").textContent = ordemServico.status || "Indefinido";
            document.getElementById("modalTipoSolicitacaoAnalise").textContent = ordemServico.tipoSolicitacao || "Sem tipo";

            // Exibe o modal
            document.getElementById("analiseModal").style.display = "block";

            // Eventos para aprovar ou recusar
            document.getElementById("aprovarButton").onclick = async function() {
                await updateOrdensServicosStatus(ordemId, "Não atribuído");
                document.getElementById("analiseModal").style.display = "none";
                loadOrdensServicos();
                countOrdensServicos();
            };

            document.getElementById("recusarButton").onclick = async function() {
                await updateOrdensServicosStatus(ordemId, "Cancelado");
                document.getElementById("analiseModal").style.display = "none";
                loadOrdensServicos();
                countOrdensServicos();
            };
        });
    }

    // Função para atualizar o status da ordem de serviço
    async function updateOrdensServicosStatus(ordemId, newStatus) {
        const docRef = doc(db, "ordemServicos", ordemId);
        await updateDoc(docRef, { status: newStatus });
    }

    // Função para contar ordens de serviço e atualizar contadores
    async function countOrdensServicos() {
        const statusCounts = {
            "Não atribuído": 0,
            "Em andamento": 0,
            "Em análise": 0
        };

        const q = query(collection(db, "ordemServicos"));
        const querySnapshot = await getDocs(q);

        querySnapshot.forEach((doc) => {
            const ordemServico = doc.data();
            if (statusCounts[ordemServico.status] !== undefined) {
                statusCounts[ordemServico.status]++;
            }
        });

        document.getElementById("naoAtribuidosCount").textContent = statusCounts["Não atribuído"];
        document.getElementById("emAndamentoCount").textContent = statusCounts["Em andamento"];
        document.getElementById("emAnaliseCount").textContent = statusCounts["Em análise"];
    }

    // Chama as funções ao carregar a página
    loadOrdensServicos();
    countOrdensServicos();

    // Função para fechar o modal
    document.querySelectorAll(".close").forEach((closeButton) => {
        closeButton.onclick = function() {
            document.querySelectorAll(".modal").forEach((modal) => {
                modal.style.display = "none";
            });
        };
    });

    // Fecha o modal se o usuário clicar fora dele
    window.onclick = function(event) {
        if (event.target.classList.contains("modal")) {
            document.querySelectorAll(".modal").forEach((modal) => {
                modal.style.display = "none";
            });
        }
    };

    function logout() {
        console.log("Logout realizado");
    }

</script>

</body>
</html>
